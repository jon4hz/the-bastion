#! /usr/bin/perl -T
# vim: set filetype=perl ts=4 sw=4 sts=4 et:
# KEYSUDOERS # as a gatekeeper, to be able to symlink in /home/allowkeeper/ACCOUNT the /home/%GROUP%/allowed.ip and allowed.forward files
# KEYSUDOERS SUPEROWNERS, %%GROUP%-gatekeeper ALL=(allowkeeper) NOPASSWD: /usr/bin/env perl -T %BASEPATH%/bin/helper/osh-groupAddSymlinkToAccount --group %GROUP% *
# FILEMODE 0750
# FILEOWN 0 allowkeeper

#>HEADER
use common::sense;
use Getopt::Long qw(:config no_auto_abbrev no_ignore_case);

use File::Basename;
use lib dirname(__FILE__) . '/../../lib/perl';
use OVH::Bastion;
use OVH::Bastion::Helper;

# Fetch command options
my $fnret;
my ($result, @optwarns);
my ($account, $group, $action);
eval {
    local $SIG{__WARN__} = sub { push @optwarns, shift };
    $result = GetOptions(
        "account=s" => sub { $account //= $_[1] },
        "group=s"   => sub { $group   //= $_[1] },    # ignore subsequent --group on cmdline (anti-sudoers-override)
        "action=s"  => sub { $action  //= $_[1] },
    );
};
if ($@) { die $@ }

if (!$result) {
    local $" = ", ";
    HEXIT('ERR_BAD_OPTIONS', msg => "Error parsing options: @optwarns");
}

OVH::Bastion::Helper::check_spurious_args();

if (not $account or not $group or not $action) {
    HEXIT('ERR_MISSING_PARAMETER', msg => "Missing argument 'account', 'group' or 'action'");
}

if (not grep { $action eq $_ } qw{ add del }) {
    HEXIT('ERR_INVALID_PARAMETER', msg => "Argument action should be either 'add' or 'del'");
}

#<HEADER

#>PARAMS:ACCOUNT
osh_debug("Checking account");
$fnret = OVH::Bastion::is_bastion_account_valid_and_existing(account => $account);
$fnret or HEXIT($fnret);

# get returned untainted value
$account = $fnret->value->{'account'};
my $sysaccount    = $fnret->value->{'sysaccount'};
my $remoteaccount = $fnret->value->{'remoteaccount'};

#<PARAMS:ACCOUNT

#>PARAMS:GROUP
# test if start by key, append if necessary
if ($group !~ /^key/) {
    $group = "key$group";
}
osh_debug("Checking group");
$fnret = OVH::Bastion::is_valid_group_and_existing(group => $group, groupType => 'key');
$fnret or HEXIT($fnret);

# get returned untainted value
$group = $fnret->value->{'group'};
my $shortGroup = $fnret->value->{'shortGroup'};

#<PARAMS:GROUP

#>RIGHTSCHECK
if ($self eq 'root') {
    osh_debug "Real root, skipping checks of permissions";
}
else {
    $fnret = OVH::Bastion::is_group_gatekeeper(account => $self, group => $shortGroup, superowner => 1, sudo => 1);
    if (!$fnret) {
        warn_syslog("$0: account $self is not a $shortGroup gatekeeper, refused to continue");
        HEXIT('ERR_NOT_ALLOWED', msg => "Sorry, you're not a gatekeeper of group $shortGroup");
    }
}

#<RIGHTSCHECK

osh_debug("user -gatek or gatek");

#>CODE
my $msg;
my $prefix = $remoteaccount ? "allowed_$remoteaccount" : "allowed";

# Handle both IP and port forwarding symlinks
my @file_types = ('ip', 'forward');
my @results;
my $any_changes = 0;

foreach my $type (@file_types) {
    my $link = "/home/allowkeeper/$sysaccount/$prefix.$type.$shortGroup";
    my $source = "/home/$group/allowed.$type";
    
    if ($action eq 'del') {
        osh_debug("Going to remove $type symlink: $link");
        if (-l $link || -e _) {
            if (unlink $link) {
                push @results, "Successfully removed $type symlink: $link";
                $any_changes = 1;
            }
            else {
                warn_syslog("$0: error while trying to remove $type symlink $link ($!)");
                HEXIT('ERR_UNLINK_FAILED', msg => "Error while trying to remove $type symlink");
            }
        }
        else {
            push @results, "$type symlink was not existing as $link, nothing to do";
        }
    }
    elsif ($action eq 'add') {
        osh_debug("Attempting to create $type symlink from $source to $link");

        if (not -e $source) {
            push @results, "Cannot create $type symlink as $source doesn't exist";
        }
        elsif (-e $link) {
            push @results, "$type symlink $link is already there, nothing to do";
        }
        else {
            if (symlink($source, $link)) {
                if ($type eq 'ip') {
                    push @results, "Account $account now has SSH access to $shortGroup servers";
                }
                elsif ($type eq 'forward') {
                    push @results, "Account $account now has port forwarding access to $shortGroup destinations";
                }
                $any_changes = 1;
            }
            else {
                warn_syslog("$0: error while creating $type symlink $source to $link ($!)");
                HEXIT('ERR_SYMLINK_FAILED', msg => "Error while creating $type symlink");
            }
        }
    }
    else {
        warn_syslog("$0: unreachable code has been reached");
        HEXIT('ERR_INTERNAL');    # unreachable
    }
}

# Create the final message and determine exit code
if (@results) {
    $msg = join("\n", @results);
}

# If no changes were made, return OK_NO_CHANGE
if (!$any_changes) {
    HEXIT('OK_NO_CHANGE', msg => $msg);
}

# If changes were made to port forwarding symlinks, regenerate SSH configs
if ($any_changes) {
    # Check if port forwarding is enabled first
    my $config_fnret = OVH::Bastion::load_configuration();
    if ($config_fnret && $config_fnret->value && $config_fnret->value->{'portForwardingEnabled'} && $config_fnret->value->{'portForwardingSSHConfigEnabled'}) {
        # Regenerate SSH port forwarding config for this account
        # Validate and untaint the account name before calling the helper
        my $account_check = OVH::Bastion::is_bastion_account_valid_and_existing(account => $account);
        if ($account_check) {
            my $untainted_account = $account_check->value->{'account'};
            my $ssh_config_fnret = OVH::Bastion::helper(
                cmd => ['sudo', '-n', '/usr/bin/env', 'perl', '-T', $OVH::Bastion::BASEPATH . '/bin/helper/osh-genSSHPFConfigs', '--account', $untainted_account]
            );
            if (!$ssh_config_fnret) {
                osh_warn("Failed to regenerate SSH port forwarding config for account $account");
            }
        }
        else {
            osh_warn("Cannot regenerate SSH config for invalid account: $account");
        }
        else {
            osh_debug("Regenerated SSH port forwarding config for account $account due to group membership change");
        }
    }
}

HEXIT("OK", msg => $msg);
